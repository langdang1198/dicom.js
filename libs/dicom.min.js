var DICOM=DICOM||{};DICOM.WebGLContext={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var canvas=document.createElement("canvas");if(window.WebGLRenderingContext){return canvas.getContext("webgl")||canvas.getContext("experimental-webgl")}else{return null}}catch(e){return null}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var element=document.createElement("div");element.id="webgl-error-message";element.style.fontFamily="monospace";element.style.fontSize="13px";element.style.fontWeight="normal";element.style.textAlign="center";element.style.background="#fff";element.style.color="#000";element.style.padding="1.5em";element.style.width="400px";element.style.margin="5em auto 0";if(!this.webgl){element.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")}return element},addGetWebGLMessage:function(parameters){var parent,id,element;parameters=parameters||{};parent=parameters.parent!==undefined?parameters.parent:document.body;id=parameters.id!==undefined?parameters.id:"oldie";element=WebGLContext.getWebGLErrorMessage();element.id=id;parent.appendChild(element)}};if(typeof module==="object"){module.exports=WebGLContext}function mouseTarget(e){var targ;if(!e)var e=window.event;if(e.target)targ=e.target;else if(e.srcElement)targ=e.srcElement;if(targ.nodeType==3)targ=targ.parentNode;return targ}function mousePositionDocument(e){var posx=0;var posy=0;if(!e){var e=window.event}if(e.pageX||e.pageY){posx=e.pageX;posy=e.pageY}else if(e.clientX||e.clientY){posx=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;posy=e.clientY+document.body.scrollTop+document.documentElement.scrollTop}return{x:posx,y:posy}}function findPos(obj){var curleft=curtop=0;if(obj.offsetParent){do{curleft+=obj.offsetLeft;curleft+=obj.clientLeft;curtop+=obj.offsetTop;curtop+=obj.clientTop}while(obj=obj.offsetParent)}return{left:curleft,top:curtop}}function mousePositionElement(e,targetElement){var mousePosDoc=mousePositionDocument(e);var target=targetElement||mouseTarget(e);var targetPos=findPos(target);var posx=mousePosDoc.x-targetPos.left;var posy=mousePosDoc.y-targetPos.top;return{x:posx,y:posy}}function deltaPosition(pos,prePos){return{x:pos.x-prePos.x,y:pos.y-prePos.y}}var Path=function(url){this.url=url};Path.prototype={construct:Path,get extension(){return this.url.split(".").pop()},get filename(){return this.url.split("\\").pop().split("/").pop()},get parentFolder(){var filename=this.filename;return this.url.slice(0,this.url.length-filename.length)},get string(){return this.url}};var DICOM=DICOM||{};DICOM.EventDispatcher=DICOM.EventDispatcher||THREE.EventDispatcher;DICOM.ObservableData=function(v){this.value=v};DICOM.ObservableData.prototype={constructor:DICOM.ObservaleData,get value(){return this._value},set value(v){if(this._value===v){return}var cumstomEvent={type:"change",newValue:v,oldValue:this._value};this._value=v;this.dispatchEvent(cumstomEvent)}};DICOM.EventDispatcher.prototype.apply(DICOM.ObservableData.prototype);DICOM.observe=function(subject,callback){subject.addEventListener("change",callback);var customEvent={type:"change",newValue:subject._value};subject.dispatchEvent(customEvent)};DICOM.bind=function(subject,callback){};var DICOM=DICOM||{};DICOM.AttachedObject=function(){};DICOM.AttachedObject.prototype.constructor=DICOM.AttachedObject;DICOM.AttachedObject.prototype.attach=function(o){this.associatedObject=o;if(this.onAttach!=null)this.onAttach()};DICOM.AttachedObject.prototype.detach=function(o){if(this.onDetach!=null)this.onDetach();this.associatedObject=undefined};DICOM.AttachedObject.prototype.apply=function(object){object.attach=DICOM.AttachedObject.prototype.attach;object.detach=DICOM.AttachedObject.prototype.detach};var DICOM=DICOM||{};DICOM.AttachedObjectCollection=function(associatedObject){this.associatedObject=associatedObject;this._associatedOjbects=[]};DICOM.AttachedObjectCollection.prototype={Constructor:DICOM.AttachedObjectCollection,clear:function(){for(var i=0;i<this._associatedOjbects.length;++i){this._associatedOjbects[i].detach()}this._associatedOjbects=[]},add:function(attachedObject){this._associatedOjbects.push(attachedObject);attachedObject.attach(this.associatedObject);var custom={type:"add",item:attachedObject};this.dispatchEvent(custom)},remove:function(attachedObject){var index=this._associatedOjbects.valueOf(attachedObject);this._associatedOjbects.splice(index,1);attachedObject.detach()},index:function(i){return this._associatedOjbects[i]},get length(){return this._associatedOjbects.length},each:function(callback){for(var i=0;i<this._associatedOjbects.length;++i){callback(this._associatedOjbects[i])}},find:function(pre){for(var i=0;i<this._associatedOjbects.length;++i){if(pre(this._associatedOjbects[i])){return this._associatedOjbects[i]}}return undefined}};DICOM.EventDispatcher.prototype.apply(DICOM.AttachedObjectCollection.prototype);var DICOM=DICOM||{};DICOM.fragmentShader="uniform sampler2D texture;uniform float windowWidth, windowLevel;varying vec2 vUv;void main()\t{    float up = windowLevel + windowWidth * 0.5;    float low = windowLevel - windowWidth * 0.5;    float gray = texture2D(texture, vUv).r;    gray = (gray-low) / windowWidth;    gl_FragColor = vec4(gray,gray,gray,1.0);}";DICOM.vertexShader="varying vec2 vUv;void main()\t{    vUv = uv;    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );}";DICOM.EventDispatcher=DICOM.EventDispatcher||THREE.EventDispatcher;DICOM.DcmSeries=function(){this.imageWrappers=[]};DICOM.EventDispatcher.prototype.apply(DICOM.DcmSeries.prototype);DICOM.DcmSeries.prototype.appendDcmArrayBuffer=function(buffer){var imageWrapper={};imageWrapper.dicomParser=new dwv.dicom.DicomParser;imageWrapper.dicomParser.parse(buffer);var tags=imageWrapper.dicomParser.getDicomElements();imageWrapper.tags=tags;imageWrapper.windowLevel=Number(tags.WindowCenter.value[0]);imageWrapper.windowWidth=Number(tags.WindowWidth.value[0]);imageWrapper.patientName=Number(tags.PatientName.value[0]);imageWrapper.row=Number(tags.Rows.value[0]);imageWrapper.column=Number(tags.Columns.value[0]);var insertedIndex=this._insertImageWrapper(imageWrapper);this.dispatchEvent({type:"append",message:imageWrapper,index:insertedIndex})};DICOM.DcmSeries.prototype._insertImageWrapper=function(imageWrapper){var instanceNumber=imageWrapper.tags.ImageNumber.value[0];var i=0;for(;i<this.imageWrappers.length;++i){if(instanceNumber<this.imageWrappers[i].tags.ImageNumber.value[0]){break}}this.imageWrappers.splice(i,0,imageWrapper);return i};DICOM.DcmSeries.prototype.onLoadedImage=function(index,callback){var image=this.imageWrappers[index];if(image){callback({image:image,index:index})}else{this.addEventListener("append",function(e){if(e.index!=index){return}var image=this.imageWrappers[index];if(image){callback({image:image,index:index})}return})}};var DICOM=DICOM||{};DICOM.Viewer=function(container,options){this.uuid=THREE.Math.generateUUID();if(typeof container==="string"){container=document.getElementById(container)}this.options=options||{};this.options.mode=this.options.mode||"debug";this.container=container;this.container.style.overflow="hidden";this.container.style.position="absolute";this.behaviors=[];this.overlays=[];this.panes=new DICOM.AttachedObjectCollection(this);var self=this;window.addEventListener("resize",function(){var e={type:"resize"};self.dispatchEvent(e)});this.container.oncontextmenu=function(e){e.preventDefault()};self.init=false};DICOM.AttachedObject.prototype.apply(DICOM.Viewer.prototype);DICOM.EventDispatcher.prototype.apply(DICOM.Viewer.prototype);DICOM.Viewer.prototype.loadDcmSeries=function(dcmSeries){this.dcmSeries=dcmSeries;this.dispatchEvent({type:"loadedDcmSeries",dcmSeries:dcmSeries})};DICOM.Viewer.prototype.render=function(){self=this;function renderImp(){if(!self.init){self.init=true;self.renderer=new THREE.WebGLRenderer({antialias:true});self.renderer.autoClear=false;var viewerWidth=self.container.clientWidth;var viewerHeight=self.container.clientHeight;self.renderer.setSize(viewerWidth,viewerHeight);self.renderer.getPrecision("highh");self.addEventListener("resize",function(e){var viewer=e.target;viewer.renderer.setSize(viewer.container.clientWidth,viewer.container.clientHeight)});console.log(window.devicePixelRatio);self.renderer.setPixelRatio(window.devicePixelRatio);self.container.appendChild(self.renderer.domElement)}else{for(var i=0;i<self.panes.length;++i){self.panes.index(i).render()}}}renderImp()};DICOM.Viewer.prototype.split=function(column,row){var self=this;var viewerWidth=self.container.clientWidth;var viewerHeight=self.container.clientHeight;var customEvent={type:"split",oldPanes:this.panes};this.panes.clear();var grid=DICOM.generateGrid(viewerWidth,viewerHeight,column,row,function(port){var pane=new DICOM.Pane(port.left,port.bottom,port.width,port.height);self.panes.add(pane);if(self.paneBuilder){self.paneBuilder(pane)}else{pane.addEventListener("loaded",function(){var topOverlay=new DICOM.Overlays.TopOverlay;pane.overlays.add(topOverlay);var cornerInfoOverlay=new DICOM.Overlays.CornerInfoOverlay;pane.overlays.add(cornerInfoOverlay);var shapeOverlay=new DICOM.Overlays.ShapeOverlay;pane.overlays.add(shapeOverlay)})}});customEvent.newPanes=this.panes;this.dispatchEvent(customEvent)};DICOM.generateGrid=function(width,height,columns,rows,callback){var step1=1/columns*100;var step2=1/rows*100;var grid=[];for(var i=0;i<rows;++i){for(var j=0;j<columns;++j){callback({left:step1*j,bottom:step2*i,width:step1,height:step2})}}return grid};DICOM.Pane=function(left,bottom,width,height){this.uuid=THREE.Math.generateUUID();this._renderAbled=false;this.left=left;this.bottom=bottom;this.width=width;this.height=height;this.container=document.createElement("div");this.container.style.left=left+"%";this.container.style.bottom=bottom+"%";this.container.style.width=width+"%";this.container.style.height=height+"%";this.container.style.position="absolute";this.borderDiv=document.createElement("div");this.borderDiv.style.left="0px";this.borderDiv.style.top="0px";this.borderDiv.style.right="0px";this.borderDiv.style.bottom="0px";this.borderDiv.style.position="absolute";this.borderDiv.style.border="1px solid yellow";this.container.appendChild(this.borderDiv);this.behaviors=new DICOM.AttachedObjectCollection(this);this.overlays=new DICOM.AttachedObjectCollection(this);this.state={};this.state.windowWidth=new DICOM.ObservableData;this.state.windowLevel=new DICOM.ObservableData;this.uniforms=this.uniforms={texture:{type:"t",value:undefined},windowWidth:{type:"f",value:undefined},windowLevel:{type:"f",value:undefined}}};DICOM.Pane.prototype=new DICOM.AttachedObject;DICOM.Pane.prototype.constructor=DICOM.Pane;DICOM.EventDispatcher.prototype.apply(DICOM.Pane.prototype);DICOM.Pane.prototype.onAttach=function(){this.viewer=this.associatedObject;this.viewer.container.appendChild(this.container);var self=this;this._onresize=function(e){if(!self.image){return}var cameraSize=self._getCameraSize();self.camera.left=cameraSize.width/-2;self.camera.right=cameraSize.width/2;self.camera.top=cameraSize.height/2;self.camera.bottom=cameraSize.height/-2;self.camera.updateProjectionMatrix();self.dispatchEvent({type:"sizeChanged"})};this.viewer.addEventListener("resize",this._onresize)};DICOM.Pane.prototype.onDetach=function(){this.viewer.container.removeChild(this.container);this.viewer.removeEventListener("resize",this._onresize);this.viewer=undefined};DICOM.Pane.prototype.loadDcmSeries=function(dcmSeries){this.dcmSeries=dcmSeries;this.state.frameIndex=new DICOM.ObservableData(0);var self=this;dcmSeries.onLoadedImage(0,function(e){self.initializeBy(e.image);DICOM.observe(self.state.frameIndex,function(e){var index=e.newValue;dcmSeries.onLoadedImage(index,function(e){self.drawImage(e.image)})})});this.dispatchEvent({type:"loadedDcmSeries",dcmSeries:dcmSeries})};DICOM.Pane.prototype.initializeBy=function(imagePrototype){this.image=imagePrototype;var geometry=new THREE.PlaneBufferGeometry(this.getImageWidth(),this.getImageHeight());var cameraSize=this._getCameraSize();this.camera=new THREE.OrthographicCamera(cameraSize.width/-2,cameraSize.width/2,cameraSize.height/2,cameraSize.height/-2,-100,100);this.scene=new THREE.Scene;var material=new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:DICOM.vertexShader,fragmentShader:DICOM.fragmentShader});material.side=THREE.DoubleSide;var imageMesh=new THREE.Mesh(geometry,material);imageMesh.position.z=0;this.scene.add(imageMesh);this.scaleRulerScene=new THREE.Scene};DICOM.Pane.prototype.drawImage=function(image){this.image=image;var self=this;var state=this.state;var uniforms=this.uniforms;state.windowWidth.value=state.windowWidth.value||image.windowWidth;state.windowLevel.value=state.windowLevel.value||image.windowLevel;DICOM.observe(this.state.windowWidth,function(e){uniforms.windowWidth.value=self.state.windowWidth.value;uniforms.windowWidth.needsUpdate=true});DICOM.observe(this.state.windowLevel,function(e){uniforms.windowLevel.value=self.state.windowLevel.value;uniforms.windowLevel.needsUpdate=true});var imgFactory=new dwv.image.ImageFactory;var img=imgFactory.create(image.dicomParser.getDicomElements(),image.dicomParser.getPixelBuffer());var width=this.image.tags.Columns.value[0];var height=this.image.tags.Rows.value[0];var imgArray=new Float32Array(width*height);for(var i=0;i<imgArray.length;++i){imgArray[i]=img.getValueAtOffset(i)}var frameTexture=new THREE.DataTexture(imgArray,width,height,THREE.LuminanceFormat,THREE.FloatType);frameTexture.needsUpdate=true;if(DICOM.WebGLContext.webgl.getExtension("OES_texture_float_linear")){frameTexture.minFilter=THREE.LinearFilter;frameTexture.magFilter=THREE.LinearFilter}else{frameTexture.minFilter=THREE.NearestFilter;frameTexture.magFilter=THREE.NearestFilter}this.uniforms.texture.value=frameTexture;this.uniforms.texture.needsUpdate=true;this.pixelBuffer=imgArray;if(!this._renderAbled){this._renderAbled=true;this.dispatchEvent({type:"loaded"})}};DICOM.Pane.prototype.getRect=function(){var left=this.container.offsetLeft;var width=this.container.offsetWidth;var height=this.container.offsetHeight;if(!this.container.offsetParent){console.error("the viewer container has not appended to document")}var bottom=this.container.offsetParent.offsetHeight-height-this.container.offsetTop;return{left:left,bottom:bottom,width:width,height:height}};DICOM.Pane.prototype.getImageWidth=function(){var pixelspacingX=Number(this.image.tags.PixelSpacing.value[0]);return this.image.tags.Columns.value[0]*pixelspacingX};DICOM.Pane.prototype.getImageHeight=function(){var pixelspacingY=Number(this.image.tags.PixelSpacing.value[1]);return this.image.tags.Rows.value[0]*pixelspacingY};DICOM.Pane.prototype.getImageValue=function(pos){var nx=pos.x/this.getImageWidth();var ny=pos.y/this.getImageHeight();if(nx<0||nx>=this.getImageWidth()||ny<0||ny>=this.getImageHeight()){return undefined}var column=this.image.tags.Columns.value[0];var row=this.image.tags.Rows.value[0];var x=Math.round(nx*column);var y=Math.round(ny*row);var offset=column*y+x;return this.pixelBuffer[offset]};DICOM.Pane.prototype._getCameraSize=function(){var rect=this.getRect();var imageWidth=this.getImageWidth();var imageHeight=this.getImageHeight();var cameraWidth,cameraHeight;var ratio=imageWidth/imageHeight;var paneRatio=rect.width/rect.height;if(ratio>paneRatio){cameraWidth=imageWidth;cameraHeight=cameraWidth/paneRatio}else{cameraHeight=imageHeight;cameraWidth=cameraHeight*paneRatio}return{width:cameraWidth,height:cameraHeight}};DICOM.Pane.prototype.render=function(){if(!this.viewer||!this._renderAbled){return}var rect=this.getRect();this.viewer.renderer.setViewport(rect.left,rect.bottom,rect.width,rect.height);this.viewer.renderer.setScissor(rect.left,rect.bottom,rect.width,rect.height);this.viewer.renderer.enableScissorTest(true);this.viewer.renderer.clear();this.viewer.renderer.render(this.scene,this.camera);this.viewer.renderer.clearDepth();this.viewer.renderer.render(this.scaleRulerScene,this.camera)};DICOM.Pane.prototype.getCameraPosition=function(domPos){var domWidth=this.container.clientWidth;var domHeight=this.container.clientHeight;var nx=domPos.x/domWidth-.5;var ny=domPos.y/domHeight-.5;var sceneX=nx*(this.camera.right-this.camera.left);var sceneY=ny*(this.camera.bottom-this.camera.top);return{x:sceneX,y:sceneY}};DICOM.Pane.prototype.getDomPosition=function(e){return mousePositionElement(e,this.container)};DICOM.Pane.prototype.getScenePosition=function(cameraPos){var tmp=new THREE.Vector4(cameraPos.x,cameraPos.y,0,1);var inMatrixWorld=new THREE.Matrix4;inMatrixWorld.getInverse(this.scene.matrixWorld);tmp.applyMatrix4(inMatrixWorld);return{x:tmp.x,y:tmp.y}};DICOM.Pane.prototype.getImagePosition=function(scenePos){return{x:scenePos.x+.5*this.getImageWidth(),y:-scenePos.y+.5*this.getImageHeight()}};DICOM.Pane.prototype.convertCameraPositionToDomPosition=function(cameraPos){var nx=cameraPos.x/(this.camera.right-this.camera.left)+.5;var ny=cameraPos.y/(this.camera.bottom-this.camera.top)+.5;var domWidth=this.container.clientWidth;var domHeight=this.container.clientHeight;return{x:domWidth*nx,y:domHeight*ny}};DICOM.bindDcmSeriesToPane=function(dcmSeries,pane){pane.dcmSeries=dcmSeries;pane.state.frameIndex=new DICOM.ObservableData(0);DICOM.observe(pane.state.frameIndex,function(e){var index=e.newValue;dcmSeries.onLoadedImage(index,function(e){pane.drawImage(e.image)})})};var DICOM=DICOM||{};DICOM.Selection=function(e){};DICOM.Selection.prototype.select=function(item){this.unselect(this._selectedItem);this._selectedItem=item;var event={type:"selected"};item.dispatchEvent(event)};DICOM.Selection.prototype.unselect=function(item){if(!item)return;if(this._selectedItem===item){this._selectedItem=undefined}var event={type:"unselected"};item.dispatchEvent(event)};var DICOM=DICOM||{};DICOM.Behavior=function(){};DICOM.Behavior.prototype=new DICOM.AttachedObject;DICOM.Behavior.prototype.constructor=DICOM.Behavior;DICOM.Behavior.prototype.onAttach=function(){this.pane=this.associatedObject};DICOM.Behavior.prototype.onDetach=function(){this.pane=undefined};DICOM.CompositeBehavior=function(){this.behaviors=[]};DICOM.CompositeBehavior.prototype=new DICOM.Behavior;DICOM.CompositeBehavior.prototype.constructor=DICOM.CompositeBehavior;DICOM.CompositeBehavior.prototype.onAttach=function(){DICOM.Behavior.prototype.onAttach.call(this);for(var i=0;i<this.behaviors.length;++i){this.behaviors[i].attach(this.pane)}};DICOM.CompositeBehavior.prototype.onDetach=function(){for(var i=0;i<this.behaviors.length;++i){this.behaviors[i].detach()}DICOM.Behavior.prototype.onDetach.call(this)};DICOM.EventDispatcher=DICOM.EventDispatcher||THREE.EventDispatcher;DICOM.MouseBehaviors=DICOM.MouseBehaviors||{};DICOM.MouseBehaviors.CapturedMouseBehavior=function(){};DICOM.MouseBehaviors.CapturedMouseBehavior.prototype=new DICOM.Behavior;DICOM.MouseBehaviors.CapturedMouseBehavior.prototype.constructor=DICOM.MouseBehaviors.CapturedMouseBehavior;DICOM.EventDispatcher.prototype.apply(DICOM.MouseBehaviors.CapturedMouseBehavior.prototype);DICOM.MouseBehaviors.CapturedMouseBehavior.prototype.onAttach=function(){DICOM.Behavior.prototype.onAttach.call(this);var capture=false;var self=this;var which;var preDomPos;var preCameraPos;var preScenePos;var button;this._mousemove=function(e){if(which==0)return;var domPos=mousePositionElement(e,self.pane.container);var cameraPos=self.pane.getCameraPosition(domPos);var scenePos=self.pane.getScenePosition(cameraPos);var customEvent={type:"capturedMousemove",button:button,domPosition:domPos,domPositionDelta:deltaPosition(domPos,preDomPos),cameraPosition:cameraPos,cameraPositionDelta:deltaPosition(cameraPos,preCameraPos),scenePosition:scenePos,scenePositionDelta:deltaPosition(scenePos,preScenePos),originalEvent:e};self.dispatchEvent(customEvent);preDomPos=domPos;preCameraPos=cameraPos;preScenePos=scenePos};this._mousedown=function(e){var domPos=preDomPos=self.pane.getDomPosition(e);var cameraPos=preCameraPos=self.pane.getCameraPosition(domPos);var scenePos=preScenePos=self.pane.getScenePosition(cameraPos);which=e.which;switch(which){case 1:button="left";break;case 2:button="middle";break;case 3:button="right";break;default:throw"unexpected"}var customEvent={type:"capturedMousedown",button:button,domPosition:domPos,cameraPosition:cameraPos,scenePosition:scenePos,originalEvent:e};self.dispatchEvent(customEvent);e.preventDefault()};this.pane.container.addEventListener("mousedown",this._mousedown);this._mouseup=function(e){if(e.which!=which)return;which=0;var domPos=mousePositionElement(e,self.pane.container);var cameraPos=self.pane.getCameraPosition(preDomPos);var scenePos=self.pane.getScenePosition(cameraPos);var customEvent={type:"capturedMouseup",button:undefined,domPosition:domPos,cameraPosition:cameraPos,scenePosition:scenePos,originalEvent:e};self.dispatchEvent(customEvent)}};DICOM.MouseBehaviors.CapturedMouseBehavior.prototype.onDetach=function(){this.pane.container.removeEventListener("mousedown",this._mousedown);this.pane.container.removeEventListener("mouseup",this._mouseup);DICOM.Behavior.prototype.onDetach.call(this)};DICOM.MouseBehaviors.CapturedMouseBehavior.prototype.capture=function(){document.addEventListener("mousemove",this._mousemove);document.addEventListener("mouseup",this._mouseup)};DICOM.MouseBehaviors.CapturedMouseBehavior.prototype.release=function(){document.removeEventListener("mousemove",this._mousemove);document.removeEventListener("mouseup",this._mouseup)};DICOM.MouseBehaviors=DICOM.MouseBehaviors||{};DICOM.MouseBehaviors.ButtonCapturedMouseBehavior=function(){};DICOM.MouseBehaviors.ButtonCapturedMouseBehavior.prototype=new DICOM.MouseBehaviors.CapturedMouseBehavior;DICOM.MouseBehaviors.ButtonCapturedMouseBehavior.prototype.constructor=DICOM.MouseBehaviors.ButtonCapturedMouseBehavior;DICOM.MouseBehaviors.ButtonCapturedMouseBehavior.prototype.onAttach=function(){DICOM.MouseBehaviors.CapturedMouseBehavior.prototype.onAttach.call(this);this.button=this.button||"left";var topOverlay=this.pane.overlays.find(function(overlay){return overlay instanceof DICOM.Overlays.TopOverlay});if(this.cursor){var preCursor=topOverlay.domElement.style.cursor;topOverlay.domElement.style.cursor=this.cursor;this.unCursor=function(){topOverlay.domElement.style.cursor=this.preCursor||"auto"}}var self=this;this._captureMousedown=function(e){if(e.button==self.button)self.capture()};this.addEventListener("capturedMousedown",this._captureMousedown);this._captureMouseup=function(e){self.release()};this.addEventListener("capturedMouseup",this._captureMouseup)};DICOM.MouseBehaviors.ButtonCapturedMouseBehavior.prototype.onDetach=function(){if(this.unCursor){this.unCursor()}this.removeEventListener("capturedMousedown",this._captureMousedown);this.removeEventListener("capturedMouseup",this._captureMouseup)};DICOM.MouseBehaviors=DICOM.MouseBehaviors||{};DICOM.MouseBehaviors.WWWLBehavior=function(button){this.button=button};DICOM.MouseBehaviors.WWWLBehavior.prototype=new DICOM.MouseBehaviors.ButtonCapturedMouseBehavior;DICOM.MouseBehaviors.WWWLBehavior.prototype.constructor=DICOM.MouseBehaviors.WWWLBehavior;DICOM.MouseBehaviors.WWWLBehavior.prototype.onAttach=function(){DICOM.MouseBehaviors.ButtonCapturedMouseBehavior.prototype.onAttach.call(this);var self=this;this._captureMousemove=function(e){var speedRatio=3;var wl=self.pane.state.windowLevel.value+e.domPositionDelta.y*speedRatio;var ww=self.pane.state.windowWidth.value+e.domPositionDelta.x*speedRatio;ww=ww>=1?ww:1;self.pane.viewer.panes.each(function(pane){pane.state.windowWidth.value=ww;pane.state.windowLevel.value=wl})};this.addEventListener("capturedMousemove",this._captureMousemove)};DICOM.MouseBehaviors.WWWLBehavior.prototype.onDetach=function(){this.removeEventListener("capturedMousemove",this._captureMousemove);DICOM.MouseBehaviors.ButtonCapturedMouseBehavior.prototype.onDetach.call(this)};DICOM.EventDispatcher=DICOM.EventDispatcher||THREE.EventDispatcher;DICOM.MouseBehaviors=DICOM.MouseBehaviors||{};DICOM.MouseBehaviors.SelectBehavior=function(selection){this.selection=selection};DICOM.MouseBehaviors.SelectBehavior.prototype=new DICOM.Behavior;DICOM.MouseBehaviors.SelectBehavior.prototype.constructor=DICOM.MouseBehaviors.SelectBehavior;DICOM.MouseBehaviors.SelectBehavior.prototype.onAttach=function(){DICOM.Behavior.prototype.onAttach.call(this);var self=this;this.pane.addEventListener("selected",function(){self.pane.borderDiv.style.border="1px solid red"});this.pane.addEventListener("unselected",function(){self.pane.borderDiv.style.border="1px solid yellow"});this._mousedown=function(e){self.selection.select(self.pane)};this.pane.container.addEventListener("mousedown",this._mousedown)};DICOM.MouseBehaviors.SelectBehavior.prototype.onDetach=function(){this.pane.container.removeEventListener("mousedown",this._mousedown);DICOM.Behavior.prototype.onAttach.call(this)};DICOM.MouseBehaviors=DICOM.MouseBehaviors||{};DICOM.MouseBehaviors.SelectShapeBehavior=function(){this.button="left"};DICOM.MouseBehaviors.SelectShapeBehavior.prototype=new DICOM.MouseBehaviors.CapturedMouseBehavior;DICOM.MouseBehaviors.SelectShapeBehavior.prototype.constructor=DICOM.MouseBehaviors.SelectShapeBehavior;DICOM.MouseBehaviors.SelectShapeBehavior.prototype.onAttach=function(){DICOM.MouseBehaviors.CapturedMouseBehavior.prototype.onAttach.call(this);this.button=this.button||"left";var topOverlay=this.pane.overlays.find(function(overlay){return overlay instanceof DICOM.Overlays.TopOverlay});if(this.cursor){var preCursor=topOverlay.domElement.style.cursor;topOverlay.domElement.style.cursor=this.cursor;this.unCursor=function(){topOverlay.domElement.style.cursor=this.preCursor||"auto"}}var self=this;var handler;var shapeOverlay=self.pane.overlays.find(function(overlay){return overlay instanceof DICOM.Overlays.ShapeOverlay});this._captureMousedown=function(e){if(e.button==self.button){var mouse={};mouse.x=e.domPosition.x/self.pane.container.clientWidth*2-1;mouse.y=-e.domPosition.y/self.pane.container.clientHeight*2+1;for(var i=0;i<shapeOverlay.shapes.length;++i){handler=shapeOverlay.shapes.index(i).hitTest(mouse);if(handler){self.capture();break}}}};this.addEventListener("capturedMousedown",this._captureMousedown);this._captureMousemove=function(e){if(handler.offset)handler.offset(e.scenePositionDelta);if(handler.moveTo)handler.moveTo(e.scenePosition)};this.addEventListener("capturedMousemove",this._captureMousemove);this._captureMouseup=function(e){handler=undefined;self.release()};this.addEventListener("capturedMouseup",this._captureMouseup)};DICOM.MouseBehaviors.SelectShapeBehavior.prototype.onDetach=function(){if(this.unCursor){this.unCursor()}this.removeEventListener("capturedMousedown",this._captureMousedown);this.removeEventListener("capturedMouseup",this._captureMouseup)};DICOM.MouseBehaviors=DICOM.MouseBehaviors||{};DICOM.MouseBehaviors.ZoomBehavior=function(button){this.button=button;this.cursor="zoom-in"};DICOM.MouseBehaviors.ZoomBehavior.prototype=new DICOM.MouseBehaviors.ButtonCapturedMouseBehavior;DICOM.MouseBehaviors.ZoomBehavior.prototype.constructor=DICOM.MouseBehaviors.ZoomBehavior;DICOM.MouseBehaviors.ZoomBehavior.prototype.onAttach=function(){DICOM.MouseBehaviors.ButtonCapturedMouseBehavior.prototype.onAttach.call(this);var self=this;this._capturedMousemove=function(e){if(Math.abs(e.domPositionDelta.y)<.1){return}self.pane.scene.scale.x*=1+e.domPositionDelta.y*.01;self.pane.scene.scale.y*=1+e.domPositionDelta.y*.01;self.pane.dispatchEvent({type:"zoom"})};this.addEventListener("capturedMousemove",this._capturedMousemove)};DICOM.MouseBehaviors.ZoomBehavior.prototype.onDetach=function(){this.removeEventListener("capturedMousemove",this._capturedMousemove);DICOM.MouseBehaviors.ButtonCapturedMouseBehavior.prototype.onDetach.call(this)};DICOM.MouseBehaviors=DICOM.MouseBehaviors||{};DICOM.MouseBehaviors.PanBehavior=function(button){this.button=button;this.cursor="move"};DICOM.MouseBehaviors.PanBehavior.prototype=new DICOM.MouseBehaviors.ButtonCapturedMouseBehavior;DICOM.MouseBehaviors.PanBehavior.prototype.constructor=DICOM.MouseBehaviors.PanBehavior;DICOM.MouseBehaviors.PanBehavior.prototype.onAttach=function(){DICOM.MouseBehaviors.ButtonCapturedMouseBehavior.prototype.onAttach.call(this);var self=this;this._captureMousemove=function(e){self.pane.scene.position.y+=e.cameraPositionDelta.y;self.pane.scene.position.x+=e.cameraPositionDelta.x};this.addEventListener("capturedMousemove",this._captureMousemove)};DICOM.MouseBehaviors.PanBehavior.prototype.onDetach=function(){this.removeEventListener("capturedMousemove",this._captureMousemove);DICOM.MouseBehaviors.ButtonCapturedMouseBehavior.prototype.onDetach.call(this)};DICOM.MouseBehaviors=DICOM.MouseBehaviors||{};DICOM.MouseBehaviors.PageBehavior=function(button){this.button=button};DICOM.MouseBehaviors.PageBehavior.prototype=new DICOM.MouseBehaviors.ButtonCapturedMouseBehavior;DICOM.MouseBehaviors.PageBehavior.prototype.constructor=DICOM.MouseBehaviors.PageBehavior;DICOM.MouseBehaviors.PageBehavior.prototype.onAttach=function(){DICOM.MouseBehaviors.ButtonCapturedMouseBehavior.prototype.onAttach.call(this);var self=this;this._captureMousemove=function(e){var index;if(e.domPositionDelta.y>.1)index=self.pane.state.frameIndex.value+1;else if(e.domPositionDelta.y<-.1){index=self.pane.state.frameIndex.value-1}else{return}index=index<0?0:index;var max=self.pane.viewer.dcmSeries.imageWrappers.length-1;index=index>max?max:index;self.pane.state.frameIndex.value=index};this.addEventListener("capturedMousemove",this._captureMousemove)};DICOM.MouseBehaviors.PageBehavior.prototype.onDetach=function(){this.removeEventListener("capturedMousemove",this._captureMousemove);DICOM.MouseBehaviors.ButtonCapturedMouseBehavior.prototype.onDetach.call(this)};DICOM.MouseBehaviors=DICOM.MouseBehaviors||{};DICOM.MouseBehaviors.WheelPageBehavior=function(button){this.button=button};DICOM.MouseBehaviors.WheelPageBehavior.prototype=new DICOM.Behavior;DICOM.MouseBehaviors.WheelPageBehavior.prototype.constructor=DICOM.MouseBehaviors.WheelPageBehavior;DICOM.MouseBehaviors.WheelPageBehavior.prototype.onAttach=function(){DICOM.Behavior.prototype.onAttach.call(this);var self=this;this._mousewheel=function(e){var e=window.event||e;var delta=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail));var index;if(delta<-.1)index=self.pane.state.frameIndex.value+1;else if(delta>.1){index=self.pane.state.frameIndex.value-1}else{return}index=index<0?0:index;var max=self.pane.viewer.dcmSeries.imageWrappers.length-1;index=index>max?max:index;self.pane.state.frameIndex.value=index};this.pane.container.addEventListener("mousewheel",this._mousewheel);this.pane.container.addEventListener("DOMMouseScroll",this._mousewheel)};DICOM.MouseBehaviors.WheelPageBehavior.prototype.onDetach=function(){this.pane.container.removeEventListener("mousewheel",this._mousewheel);this.pane.container.removeEventListener("DOMMouseScroll",this._mousewheel);DICOM.Behavior.prototype.onDetach.call(this)};DICOM.Shapes=DICOM.Shapes||{};DICOM.Shapes.Line=function(){this.geometry=new THREE.Geometry;this.geometry.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0));this.geometry.dynamic=true;this.material=new THREE.LineBasicMaterial({color:16711680,linewidth:2});this.nodeMaterial=new THREE.MeshBasicMaterial({color:16711680,side:THREE.DoubleSide});this.shape=new THREE.Line(this.geometry,this.material);var nodeGeometry=new THREE.CircleGeometry(2,32);this.nodes=[];this.nodes[0]=new THREE.Mesh(nodeGeometry,this.nodeMaterial);this.nodes[0].position.x=0;this.nodes[0].position.y=0;this.nodes[0].position.z=0;var nodeGeometry1=new THREE.CircleGeometry(2,32);this.nodes[1]=new THREE.Mesh(nodeGeometry1,this.nodeMaterial);this.nodes[1].position.x=0;this.nodes[1].position.y=0;this.nodes[1].position.z=0;this.shape.add(this.nodes[0]);this.shape.add(this.nodes[1])};DICOM.Shapes.Line.prototype={constructor:DICOM.Shapes.Line,get startPoint(){return this.shape.geometry.vertices[0]},set startPoint(point){this.shape.geometry.vertices[0].copy(point);this.nodes[0].position.x=point.x;this.nodes[0].position.y=point.y;this.shape.geometry.verticesNeedUpdate=true},get endPoint(){return this.shape.geometry.vertices[1]},set endPoint(point){this.shape.geometry.vertices[1].copy(point);this.nodes[1].position.x=point.x;this.nodes[1].position.y=point.y;this.shape.geometry.verticesNeedUpdate=true},bugWalkaround:function(){this.shape.geometry.computeBoundingSphere()},onAttach:function(){this.associatedObject.pane.scene.add(this.shape)},onDetach:function(){this.associatedObject.pane.scene.remove(this.shape)},hitTest:function(pos){var raycaster=new THREE.Raycaster;raycaster.linePrecision=3;raycaster.setFromCamera(pos,this.associatedObject.pane.camera);var self=this;var intersets=raycaster.intersectObjects(this.nodes);var handlers={};handlers[this.nodes[0].uuid]={moveTo:function(pos){self.startPoint=new THREE.Vector3(pos.x,pos.y,0)}};handlers[this.nodes[1].uuid]={moveTo:function(pos){self.endPoint=new THREE.Vector3(pos.x,pos.y,0)}};if(intersets.length>0){return handlers[intersets[0].object.uuid]}var intersets2=raycaster.intersectObjects([this.shape]);if(intersets2.length>0){console.log("hitted line");return{offset:function(delta){console.log(delta);self.startPoint=new THREE.Vector3(self.startPoint.x+delta.x,self.startPoint.y+delta.y,0);self.endPoint=new THREE.Vector3(self.endPoint.x+delta.x,self.endPoint.y+delta.y,0);self.bugWalkaround();console.log(self.startPoint)}}}}};DICOM.AttachedObject.prototype.apply(DICOM.Shapes.Line.prototype);DICOM.MouseBehaviors=DICOM.MouseBehaviors||{};DICOM.MouseBehaviors.InsertLineBehavior=function(button){this.cursor="crosshair";this.button=button};DICOM.MouseBehaviors.InsertLineBehavior.prototype=new DICOM.MouseBehaviors.ButtonCapturedMouseBehavior;DICOM.MouseBehaviors.InsertLineBehavior.prototype.constructor=DICOM.MouseBehaviors.InsertLineBehavior;DICOM.MouseBehaviors.InsertLineBehavior.prototype.onAttach=function(){DICOM.MouseBehaviors.ButtonCapturedMouseBehavior.prototype.onAttach.call(this);var shapeOverlay=this.pane.overlays.find(function(x){return x instanceof DICOM.Overlays.ShapeOverlay});var self=this;this._capturedMousedown=function(e){var pos=new THREE.Vector3(e.scenePosition.x,e.scenePosition.y,0);self.line=new DICOM.Shapes.Line;self.line.endPoint=self.line.startPoint=new THREE.Vector3(e.scenePosition.x,e.scenePosition.y,10);self.line.geometry.verticesNeedUpdate=true;shapeOverlay.shapes.add(self.line);e.originalEvent.preventDefault()};this.addEventListener("capturedMousedown",this._capturedMousedown);this._capturedMousemove=function(e){self.line.endPoint=new THREE.Vector3(e.scenePosition.x,e.scenePosition.y,10);var startImgPos=(new THREE.Vector2).copy(self.pane.getImagePosition(self.line.startPoint));var endImgPos=(new THREE.Vector2).copy(self.pane.getImagePosition(self.line.endPoint));var length=endImgPos.sub(startImgPos).length();e.originalEvent.preventDefault();shapeOverlay.lengthDiv.innerHTML="length: "+length.toFixed(2)+"mm"};this.addEventListener("capturedMousemove",this._capturedMousemove);this._capturedMouseup=function(e){self.line.bugWalkaround();e.originalEvent.preventDefault()};this.addEventListener("capturedMouseup",this._capturedMouseup)};DICOM.MouseBehaviors.InsertLineBehavior.prototype.onDetach=function(){this.removeEventListener("capturedMousedown",this._capturedMousedown);this.removeEventListener("capturedMousemove",this._capturedMousemove);this.removeEventListener("capturedMouseup",this._capturedMouseup);DICOM.MouseBehaviors.ButtonCapturedMouseBehavior.prototype.onDetach.call(this)};DICOM.MouseBehaviors=DICOM.MouseBehaviors||{};DICOM.MouseBehaviors.PixelBehavior=function(button){this.button=button};DICOM.MouseBehaviors.PixelBehavior.prototype=new DICOM.Behavior;DICOM.MouseBehaviors.PixelBehavior.prototype.constructor=DICOM.MouseBehaviors.PixelBehavior;DICOM.MouseBehaviors.PixelBehavior.prototype.onAttach=function(){DICOM.Behavior.prototype.onAttach.call(this);var self=this;var cornerOverlay=this.cornerOverlay=this.pane.overlays.find(function(overlay){return overlay instanceof DICOM.Overlays.CornerInfoOverlay});var pixelLi=this.pixelLi=document.createElement("li");pixelLi.innerHTML="Hu: NaN";cornerOverlay.leftBottomCorner.appendChild(pixelLi);this._mousemove=function(e){var domPos=self.pane.getDomPosition(e);var cameraPos=self.pane.getCameraPosition(domPos);var scenePos=self.pane.getScenePosition(cameraPos);var imagePos=self.pane.getImagePosition(scenePos);pixelLi.innerHTML="Hu: "+(self.pane.getImageValue(imagePos)||"NaN")};this.pane.container.addEventListener("mousemove",this._mousemove);this._mouseleave=function(e){pixelLi.innerHTML="Hu: "+"NaN"};this.pane.container.addEventListener("mouseleave",this._mouseleave)};DICOM.MouseBehaviors.PixelBehavior.prototype.onDetach=function(){this.cornerOverlay.leftBottomCorner.removeChild(this.pixelLi);this.pane.container.removeEventListener("mousemove",this._mousemove);this.pane.container.removeEventListener("mouseleave",this._mouseleave);DICOM.Behavior.prototype.onDetach.call(this)};DICOM.TouchBehaviors=DICOM.TouchBehaviors||{};DICOM.TouchBehaviors.WWWLBehavior=function(){};DICOM.TouchBehaviors.WWWLBehavior.prototype=new DICOM.Behavior;DICOM.TouchBehaviors.WWWLBehavior.prototype.constructor=DICOM.TouchBehaviors.WWWLBehavior;DICOM.TouchBehaviors.WWWLBehavior.prototype.onAttach=function(){var self=this;var preX,preY;this._touchstart=function(e){if(e.touches.length!=1)return;preX=e.touches[0].clientX;preY=e.touches[0].clientY;e.preventDefault()};this.pane.overlay.addEventListener("touchstart",this._touchstart);this._touchmove=function(e){if(e.touches.length!=1||preX==undefined||preY==undefined)return;var tmpX=e.touches[0].clientX;var tmpY=e.touches[0].clientY;self.viewer.windowLevel+=tmpY-preY;self.viewer.windowWidth+=tmpX-preX;self.viewer.windowWidth=self.viewer.windowWidth>=1?self.viewer.windowWidth:1;self.viewer.uniforms.windowWidth.value=self.viewer.windowWidth;self.viewer.uniforms.windowLevel.value=self.viewer.windowLevel;self.viewer.uniforms.windowWidth.needsUpdate=true;self.viewer.uniforms.windowLevel.needsUpdate=true;var event=new CustomEvent("wwwl",{detail:{windowLevel:self.viewer.windowLevel,windowWidth:self.viewer.windowWidth}});self.viewer.container.dispatchEvent(event);preX=tmpX;preY=tmpY;e.preventDefault()};this.pane.overlay.addEventListener("touchmove",this._touchmove);this._touchend=function(e){preX=undefined;preY=undefined};this.pane.overlay.addEventListener("touchend",this._touchend)};DICOM.TouchBehaviors.WWWLBehavior.prototype.onDetach=function(){this.pane.overlay.removeEventListener("touchstart",this._touchstart);this.pane.overlay.removeEventListener("touchmove",this._touchmove);this.pane.overlay.removeEventListener("touchend",this._touchend)};DICOM.TouchBehaviors=DICOM.TouchBehaviors||{};DICOM.TouchBehaviors.ZoomBehavior=function(){};DICOM.TouchBehaviors.ZoomBehavior.prototype=new DICOM.Behavior;DICOM.TouchBehaviors.ZoomBehavior.prototype.constructor=DICOM.TouchBehaviors.ZoomBehavior;DICOM.TouchBehaviors.ZoomBehavior.prototype.onAttach=function(){var self=this;var preDistance;this._touchstart=function(e){if(e.touches.length!=2)return;preDistance=Math.sqrt(Math.pow(e.touches[1].clientX-e.touches[0].clientX,2)+Math.pow(e.touches[1].clientY-e.touches[0].clientY,2));e.preventDefault()};this.viewer.container.addEventListener("touchstart",this._touchstart);this._touchmove=function(e){if(e.touches.length!=2)return;var currentDistance=Math.sqrt(Math.pow(e.touches[1].clientX-e.touches[0].clientX,2)+Math.pow(e.touches[1].clientY-e.touches[0].clientY,2));var scala=currentDistance/preDistance;self.viewer.imageMesh.scale.x*=scala;self.viewer.imageMesh.scale.y*=scala;var scaleX=self.viewer.imageMesh.scale.x;var scaleY=self.viewer.imageMesh.scale.y;var ce=new CustomEvent("scale",{detail:{scale:scaleX}});self.viewer.container.dispatchEvent(ce);preDistance=currentDistance;e.preventDefault()};this.viewer.container.addEventListener("touchmove",this._touchmove);this._touchend=function(e){preDistance=undefined};this.viewer.container.addEventListener("touchend",this._touchend)};DICOM.TouchBehaviors.ZoomBehavior.prototype.onDetach=function(){this.viewer.container.removeEventListener("touchstart",this._touchstart);this.viewer.container.removeEventListener("touchmove",this._touchmove)};DICOM.TouchBehaviors=DICOM.TouchBehaviors||{};DICOM.TouchBehaviors.PanBehavior=function(){};DICOM.TouchBehaviors.PanBehavior.prototype=new DICOM.Behavior;DICOM.TouchBehaviors.PanBehavior.prototype.constructor=DICOM.TouchBehaviors.PanBehavior;DICOM.TouchBehaviors.PanBehavior.prototype.onAttach=function(){var self=this;var preX,preY;this._touchstart=function(e){if(e.touches.length!=1)return;preX=e.touches[0].clientX;preY=e.touches[0].clientY;e.preventDefault()};this.viewer.container.addEventListener("touchstart",this._touchstart);this._touchmove=function(e){if(e.touches.length!=1||preX==undefined||preY==undefined)return;self.viewer.imageMesh.position.x+=e.touches[0].clientX-preX;self.viewer.imageMesh.position.y-=e.touches[0].clientY-preY;preX=e.touches[0].clientX;preY=e.touches[0].clientY;e.preventDefault()};this.viewer.container.addEventListener("touchmove",this._touchmove);this._touchend=function(e){preX=undefined;preY=undefined};this.viewer.container.addEventListener("touchend",this._touchend)};DICOM.TouchBehaviors.PanBehavior.prototype.onDetach=function(){this.viewer.container.removeEventListener("touchstart",this._touchstart);this.viewer.container.removeEventListener("touchmove",this._touchmove);this.viewer.container.removeEventListener("touchend",this._touchend)};DICOM.BehaviorHelper={};DICOM.BehaviorHelper.create=function(name){if(name=="default"){var defaultBehavior=new DICOM.CompositeBehavior;defaultBehavior.behaviors.push(new DICOM.MouseBehaviors.PageBehavior("left"));defaultBehavior.behaviors.push(new DICOM.MouseBehaviors.WWWLBehavior("right"));return defaultBehavior}if(name=="pan"){return new DICOM.MouseBehaviors.PanBehavior("left")}if(name=="zoom"){return new DICOM.MouseBehaviors.ZoomBehavior("left")}if(name=="WWWL"){return new DICOM.MouseBehaviors.WWWLBehavior("left")}if(name=="page"){return new DICOM.MouseBehaviors.PageBehavior("left")}if(name=="pixel"){return new DICOM.MouseBehaviors.PixelBehavior("left")}if(name=="line"){return new DICOM.MouseBehaviors.InsertLineBehavior("left")}if(name=="select"){return new DICOM.MouseBehaviors.SelectShapeBehavior("select")}};var DICOM=DICOM||{};DICOM.Command=function(){};DICOM.AttachedObject.prototype.apply(DICOM.Command.prototype);DICOM.Command.prototype.onAttach=function(){this.pane=this.associatedObject};DICOM.Commands=DICOM.Commands||{};DICOM.Commands.RotateCommand=function(rad){this.rad=rad};DICOM.Commands.RotateCommand.prototype=new DICOM.Command;DICOM.Commands.RotateCommand.prototype.constructor=DICOM.RotateCommand;DICOM.Commands.RotateCommand.prototype.execute=function(){var rotation=this.pane.scene.rotation;if(Math.cos(rotation.x)*Math.cos(rotation.y)>0){rotation.z+=this.rad}else{rotation.z-=this.rad}};DICOM.Commands=DICOM.Commands||{};DICOM.Commands.FlipCommand=function(direction){this.direction=direction};DICOM.Commands.FlipCommand.prototype=new DICOM.Command;DICOM.Commands.FlipCommand.prototype.constructor=DICOM.FlipCommand;DICOM.Commands.FlipCommand.prototype.execute=function(){if(this.direction=="x"){this.pane.scene.rotation.x+=Math.PI}if(this.direction=="y"){this.pane.scene.rotation.y+=Math.PI}};DICOM.CommandHelper={};DICOM.CommandHelper.create=function(cmd){if(cmd.type=="flip"){return new DICOM.Commands.FlipCommand(cmd.arguments)}if(cmd.type=="rotate"){return new DICOM.Commands.RotateCommand(cmd.arguments)}};var DICOM=DICOM||{};DICOM.Overlays=DICOM.Overlays||{};DICOM.Overlays.Overlay=function(){};DICOM.Overlays.Overlay.prototype=new DICOM.AttachedObject;DICOM.Overlays.Overlay.prototype.onAttach=function(pane){this.domElement=document.createElement("div");this.domElement.style.position="absolute";this.domElement.style.left="0";this.domElement.style.top="0";this.domElement.style.right="0";this.domElement.style.bottom="0";this.pane=this.associatedObject;this.pane.container.appendChild(this.domElement)};DICOM.Overlays.Overlay.prototype.onDetach=function(pane){this.pane=undefined};var DICOM=DICOM||{};DICOM.Overlays.CornerInfoOverlay=function(){};DICOM.Overlays.CornerInfoOverlay.prototype=new DICOM.Overlays.Overlay;DICOM.Overlays.CornerInfoOverlay.prototype.constructor=DICOM.Overlays.CornerInfoOverlay;DICOM.Overlays.CornerInfoOverlay.prototype.onAttach=function(){DICOM.Overlays.Overlay.prototype.onAttach.call(this);this.domElement.style.color="white";this.domElement.style.fontSize="10px";this.leftTopCorner=document.createElement("ul");this.leftTopCorner.style.top=0;this.leftTopCorner.style.left=0;this.leftTopCorner.style.padding="0.5em";this.leftTopCorner.style.margin=0;this.leftTopCorner.style.listStyle="none";this.leftTopCorner.style.position="absolute";this.domElement.appendChild(this.leftTopCorner);this.rightTopCorner=document.createElement("ul");this.rightTopCorner.style.top=0;this.rightTopCorner.style.right=0;this.rightTopCorner.style.padding="0.5em";this.rightTopCorner.style.margin=0;this.rightTopCorner.style.listStyle="none";this.rightTopCorner.style.position="absolute";this.domElement.appendChild(this.rightTopCorner);this.leftBottomCorner=document.createElement("ul");this.leftBottomCorner.style.bottom=0;this.leftBottomCorner.style.left=0;this.leftBottomCorner.style.padding="0.5em";this.leftBottomCorner.style.margin=0;this.leftBottomCorner.style.listStyle="none";this.leftBottomCorner.style.position="absolute";this.domElement.appendChild(this.leftBottomCorner);this.rightBottomCorner=document.createElement("ul");this.rightBottomCorner.style.bottom=0;this.rightBottomCorner.style.right=0;this.rightBottomCorner.style.padding="0.5em";this.rightBottomCorner.style.margin=0;this.rightBottomCorner.style.listStyle="none";this.rightBottomCorner.style.position="absolute";this.domElement.appendChild(this.rightBottomCorner);var patientName=this.pane.viewer.dcmSeries.patientName;var patientLi=document.createElement("li");patientLi.innerHTML=patientName;this.leftTopCorner.appendChild(patientLi);var windowLevelLi=document.createElement("li");this.rightTopCorner.appendChild(windowLevelLi);DICOM.observe(this.pane.state.windowLevel,function(e){windowLevelLi.innerHTML="WL: "+e.newValue});var windowWidthLi=document.createElement("li");this.rightTopCorner.appendChild(windowWidthLi);DICOM.observe(this.pane.state.windowWidth,function(e){windowWidthLi.innerHTML="WW: "+e.newValue})};DICOM.Overlays.CornerInfoOverlay.prototype.onDetach=function(){DICOM.Overlays.Overlay.prototype.onDetach.call(this)};DICOM.Overlays.ScaleOverlay=function(){};DICOM.Overlays.ScaleOverlay.prototype=new DICOM.Overlays.Overlay;DICOM.Overlays.ScaleOverlay.prototype.onAttach=function(){DICOM.Overlays.Overlay.prototype.onAttach.call(this);this.refreshScaleRuler();var self=this;this._refresh=function(){self.refreshScaleRuler()};this.pane.addEventListener("zoom",this._refresh);this.pane.addEventListener("sizeChanged",this._refresh)};DICOM.Overlays.ScaleOverlay.prototype.refreshScaleRuler=function(){if(this.scaleRuler){this.pane.scaleRulerScene.remove(this.scaleRuler);this.scaleRuler=undefined;this.domElement.removeChild(this.txtSpan)}var self=this;var pixelspacingX=Number(this.pane.imageWrapper.tags.PixelSpacing.value[0]);var pixelspacingY=Number(this.pane.imageWrapper.tags.PixelSpacing.value[1]);if(pixelspacingX!=pixelspacingY){console.log("Error: the pixelspacing is not same.")}var scale=this.pane.scene.scale.x;var tenMM=10;var material=new THREE.LineBasicMaterial({color:16776960});var scaleRect=this.getScaleRulerRect();var bottomPos=scaleRect.top+scaleRect.height;var bottomPos2=scaleRect.top;var geometry=new THREE.Geometry;geometry.vertices.push(new THREE.Vector3(tenMM,bottomPos,0),new THREE.Vector3(-tenMM,bottomPos,0));var scaleRuler=new THREE.Line(geometry,material);var tickGeometry=new THREE.Geometry;tickGeometry.vertices.push(new THREE.Vector3(0,bottomPos,0),new THREE.Vector3(0,bottomPos2,0));var tick=new THREE.Line(tickGeometry,material);scaleRuler.add(tick);var tickGeometry1=new THREE.Geometry;tickGeometry1.vertices.push(new THREE.Vector3(tenMM,bottomPos,0),new THREE.Vector3(tenMM,bottomPos2,0));var tick1=new THREE.Line(tickGeometry1,material);scaleRuler.add(tick1);var tickGeometry2=new THREE.Geometry;tickGeometry2.vertices.push(new THREE.Vector3(-tenMM,bottomPos,0),new THREE.Vector3(-tenMM,bottomPos2,0));var tick2=new THREE.Line(tickGeometry2,material);scaleRuler.add(tick2);this.scaleRuler=scaleRuler;this.scaleRuler.scale.x=scale;this.pane.scaleRulerScene.add(scaleRuler);var txtPos=this.getScaleRulerTextPosition();var txtSpan=this.txtSpan=document.createElement("span");txtSpan.innerHTML="1cm";txtSpan.style.color="white";txtSpan.style.position="absolute";txtSpan.style.top=txtPos.top+"px";txtSpan.style.left=txtPos.left+"px";txtSpan.style.color="yellow";this.domElement.appendChild(txtSpan)};DICOM.Overlays.ScaleOverlay.prototype.getScaleRulerRect=function(){var clientWidth=this.pane.container.clientWidth;var clientHeight=this.pane.container.clientHeight;var bottom=20;var height=7;var width=clientWidth*.5;var left=(clientWidth-width)*.5;var right=left;var top=clientHeight-bottom-height;var lt=this.pane.getCameraPosition({x:left,y:top});var rb=this.pane.getCameraPosition({x:left+width,y:top+height});return{left:lt.x,top:lt.y,width:rb.x-lt.x,height:rb.y-lt.y}};DICOM.Overlays.ScaleOverlay.prototype.getScaleRulerTextPosition=function(){var clientWidth=this.pane.container.clientWidth;var clientHeight=this.pane.container.clientHeight;var left=clientWidth*.5;var top=clientHeight-17;return{left:left,top:top}};DICOM.Overlays.ShapeOverlay=function(){};DICOM.Overlays.ShapeOverlay.prototype=new DICOM.Overlays.Overlay;DICOM.Overlays.ShapeOverlay.prototype.constructor=DICOM.Overlays.ShapeOverlay;DICOM.Overlays.ShapeOverlay.prototype.onAttach=function(){DICOM.Overlays.Overlay.prototype.onAttach.call(this);this.shapes=new DICOM.AttachedObjectCollection(this);this.lengthDiv=document.createElement("div");this.lengthDiv.style.top="50%";this.lengthDiv.style.right=0;this.lengthDiv.style.color="red";this.lengthDiv.style.padding="0.5em";this.lengthDiv.style.position="absolute";this.domElement.appendChild(this.lengthDiv)};DICOM.Overlays.ShapeOverlay.prototype.onDetach=function(){this.domElement.removeChild(this.lengthDiv);DICOM.Overlays.Overlay.prototype.onDetach.call(this)};DICOM.Overlays.TopOverlay=function(){};DICOM.Overlays.TopOverlay.prototype=new DICOM.Overlays.Overlay;DICOM.Overlays.TopOverlay.prototype.constructor=DICOM.Overlays.TopOverlay;DICOM.Overlays.TopOverlay.prototype.onAttach=function(){DICOM.Overlays.Overlay.prototype.onAttach.call(this);this.domElement.style.zIndex="100"};DICOM.Overlays.TopOverlay.prototype.onDetach=function(){DICOM.Overlays.Overlay.prototype.onDetach.call(this)};DICOM.Application=function(){this.viewers=new DICOM.AttachedObjectCollection;this.thumbnailViewers=new DICOM.AttachedObjectCollection;this.behaviorID=new DICOM.ObservableData("default");this._behaviorLut={};this.paneSelection=new DICOM.Selection;var self=this;this.viewerFactory=new DICOM.ViewerFactory;this.viewers.addEventListener("add",function(e){var viewer=e.item;viewer.addEventListener("split",function(e){var panes=e.newPanes;panes.each(function(pane){var selectBehavior=new DICOM.MouseBehaviors.SelectBehavior(self.paneSelection);pane.behaviors.add(selectBehavior);var wheelPageBehavior=new DICOM.MouseBehaviors.WheelPageBehavior;pane.behaviors.add(wheelPageBehavior);var behavior=DICOM.BehaviorHelper.create(self.behaviorID.value);pane.behaviors.add(behavior);self._behaviorLut[pane.uuid]=behavior})})});var self=this;DICOM.observe(this.behaviorID,function(e){self.viewers.each(function(viewer){viewer.panes.each(function(pane){if(self._behaviorLut[pane.uuid]){pane.behaviors.remove(self._behaviorLut[pane.uuid])}var behavior=DICOM.BehaviorHelper.create(self.behaviorID.value);pane.behaviors.add(behavior);self._behaviorLut[pane.uuid]=behavior})})})};DICOM.Application.prototype={constructor:DICOM.Application,createViewer:function(container,id){var viewer=this.viewerFactory.createViewer(container);this.viewers.add(viewer);viewer.split(1,1);viewer.addEventListener("loadedDcmSeries",function(e){viewer.panes.each(function(pane){pane.loadDcmSeries(e.dcmSeries)})});viewer.addEventListener("split",function(e){if(viewer.dcmSeries){viewer.panes.each(function(pane){pane.loadDcmSeries(viewer.dcmSeries)})}});return viewer},executeByID:function(cmd){var pane=this.paneSelection._selectedItem;var cmd=DICOM.CommandHelper.create(cmd);cmd.attach(pane);cmd.execute()},setWWWL:function(ww,wl){this.viewers.each(function(viewer){viewer.panes.each(function(pane){pane.state.windowWidth.value=ww;pane.state.windowLevel.value=wl})})},render:function(){this.viewers.each(function(viewer){viewer.render()});this.thumbnailViewers.each(function(viewer){viewer.render()})},getCurrentViewer:function(){var selectionPane=this.paneSelection._selectedItem;return selectionPane.viewer}};DICOM.ViewerFactory=function(){};DICOM.ViewerFactory.prototype.createViewer=function(container){var viewer=new DICOM.Viewer(container);return viewer};